name: Update Badge

on:
  schedule:
    - cron: '0 */12 * * *'  # Runs every 12 hours
  workflow_dispatch:  # Allows manual trigger

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v2
      
    - name: Update README.md with AWK
      run: |
        # Generate a unique query string using the current UNIX timestamp
        UNIQUE_STRING=$(date +%s)
        # Use awk to update the README.md file with the new query string for the badge URL
        awk -v unique="$UNIQUE_STRING" '{ gsub(/tryhackme-badge-workflow\/main\/badge\.png\?version=[0-9]+/, "tryhackme-badge-workflow/main/badge.png?version="unique); print }' README.md > temp_README.md && mv temp_README.md README.md
        # Display the modified README contents to verify the operation
        cat README.md
        
    - name: Commit and push if changes are detected
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        git add README.md
        git diff-index --quiet HEAD || git commit -m "Automatically update badge query string with AWK"
        git push
